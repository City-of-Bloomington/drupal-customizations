<?php
/**
 * @copyright 2013 City of Bloomington, Indiana
 * @license http://www.gnu.org/licenses/agpl.txt GNU/AGPL, see LICENSE.txt
 * @author Cliff Ingham <inghamn@bloomington.in.gov>
 */
function cob_node_siblings(array &$node)
{
	$field = 'field_'.$node['#bundle'];

	if (isset(   $node[$field]['#items'][0]['target_id'])) {
		$pid   = $node[$field]['#items'][0]['target_id'];
		$query = new EntityFieldQuery();

		$query->entityCondition('entity_type', 'node')
				->entityCondition('bundle', $node['#bundle'])
				->propertyCondition('status', 1)
				->propertyCondition('nid', $node['#node']->nid, '<>')
				->fieldCondition('field_program', 'target_id', $pid);
		$results = $query->execute();
		if (!empty($results['node'])) {
			return node_load_multiple(array_keys($results['node']));
		}
	}
}

/**
 * Returns the top level programs that reference a node
 *
 * @param array $node
 */
function cob_node_programs(array &$node)
{
	$bundle = $node['#bundle'];

	$sql = "select l.entity_id as program_id
			from field_data_field_$bundle l
			left join field_data_field_program p on (p.entity_type='node' and l.entity_id=p.entity_id)
			where l.field_{$bundle}_target_id=?
			and l.bundle='program'
			and p.field_program_target_id is null";
	$results = db_query($sql, array($node['#node']->nid));

	$programs = array();
	foreach ($results as $row) {
		$programs[] = $row->program_id;
	}
	$nodes = node_load_multiple($programs);
	return $nodes;
}

/**
 * Returns a parent node that has a logo
 *
 * This will iterate over all the possible node references
 * and return a reference to one of them that actually has a logo.
 * This is useful for rendering a logo from a node reference
 * when the current node does not have a logo defined on itself.
 *
 * @return object The node object
 */
function cob_logo_parent($node_id)
{
	$fields = ['program', 'department', 'board_or_commission', 'location'];
	foreach ($fields as $f) {
		$sql = "select f.field_{$f}_target_id
				from field_data_field_$f f
				join field_data_field_logo l on l.entity_type='node' and f.field_{$f}_target_id=l.entity_id
				where f.entity_type='node' and f.entity_id=?";
		$pid = db_query($sql, array($node_id))->fetchField();
		if ($pid) {
			return node_load($pid);
		}
	}
}
