<?php
/**
 * @copyright 2013 City of Bloomington, Indiana
 * @license http://www.gnu.org/licenses/agpl.txt GNU/AGPL, see LICENSE.txt
 * @author Cliff Ingham <inghamn@bloomington.in.gov>
 */
function cob_node_siblings(array &$node)
{
	$field = 'field_'.$node['#bundle'];

	if (isset(   $node[$field]['#items'][0]['target_id'])) {
		$pid   = $node[$field]['#items'][0]['target_id'];
		$query = new EntityFieldQuery();

		$query->entityCondition('entity_type', 'node')
				->entityCondition('bundle', $node['#bundle'])
				->propertyCondition('status', 1)
				->propertyCondition('nid', $node['#node']->nid, '<>')
				->fieldCondition('field_program', 'target_id', $pid);
		$results = $query->execute();
		if (!empty($results['node'])) {
			return node_load_multiple(array_keys($results['node']));
		}
	}
}

function cob_location_programs($location_node_id)
{
	$sql = "select l.entity_id as program_id
			from field_data_field_location l
			left join field_data_field_program p on (p.entity_type='node' and l.entity_id=p.entity_id)
			where l.field_location_target_id=?
			and l.bundle='program'
			and p.field_program_target_id is null";
	$results = db_query($sql, array($location_node_id));

	$programs = array();
	foreach ($results as $row) {
		$programs[] = $row->program_id;
	}
	$nodes = node_load_multiple($programs);
	return $nodes;
}
